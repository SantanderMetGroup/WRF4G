#!/usr/bin/env python
import os
import sys 
from commands import getstatusoutput
from optparse import OptionParser
from os.path  import join, dirname, abspath
try:
    import vcplib
    import WRF4Glib
except Exception, e:
    print 'Caught exception: %s' % (str(e))
    sys.exit(-1)


usage="""%prog type date

Example:    %prog rst 1990-01-01_00:00:00 
            %prog real 1990-01-01_00:00:00

This command needs that the following environment variables have been established: WRF4G_EXPERIMENT, WRF4G_REALIZATION and RESOURCES_WRF4G.
"""

# Check the Arguments
parser = OptionParser(usage,version="%prog 1.0")
parser.add_option("-v", "--verbose",action="store_true", dest="verbose", default=False,help="Verbose mode. Explain what is being done")
(options, args) = parser.parse_args()

if len(args) == 2 :
    type, date  = args
else :
    parser.error("Incorrect number of arguments")
    sys.exit(-1)

# Check that the environment variables has been established and import their values
env_var = {}
for var in [ "WRF4G_EXPERIMENT" , "WRF4G_REALIZATION", "WRF4G_BASEPATH"] :
    var_value = os.getenv(var)
    if not var_value :
        sys.stderr.write( var + " is not defined\n")
        sys.exit(-1)
    env_var[var] = var_value

sys.stderr.write("WRFGEL(download_file)> START: %s\n" % args)

type_list={
           "rst"  : "restart",
           "real" : "realout"
           }

pattern = {
           "rst"  : "wrfrst*"           + date + "*" ,
           "real" : "wrf[lbif]*_d\d\d_" + date + "*"
           } 

orig_folder = join( env_var[ "WRF4G_BASEPATH"] , env_var["WRF4G_EXPERIMENT"] , env_var["WRF4G_REALIZATION"] , type_list[type] + "/" )
for file in vcplib.VCPURL(orig_folder).ls(pattern[type]):
    # file will follow the pattern: wrfrst_d01_19900101T000000Z.nc or wrflowinp_d08_19900101T000000Z.nc
    file_c = WRF4Glib.wrffile(file)
    if type == "rst" :
        dest = file_c.file_name + file_c.date_wrf()
    else: 
        # From wrflowinp_d08_ we remove the _ at the end
        dest = file_c.file_name[:-1]
    orig_file = join(orig_folder,file)
    try:
        vcplib.copy_file(orig_file,dest,verbose=options.verbose)
    except Exception, e:
        sys.stderr.write(file + " has not copied to " + dest + "\n")
        sys.exit(-1)
sys.stderr.write("WRFGEL(download_file)> END: %s\n" % args)
