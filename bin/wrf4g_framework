#! /bin/bash

# wrf4g_framework manages DRM4G (GridWay) and WRF4G_DB (MySQL) components of WRF4G.

# Common initialization
. `dirname $0`/wrf4g_env

case "$1" in
  start)
    sed -i "s#\$HOSTNAME#$HOSTNAME#" $FRAMEWORK4G_CONF
    if test -f ${WRF4G_LOCATION}/etc/resources.wrf4g; then
      sed -i 's/\ *=\ */=/' ${WRF4G_LOCATION}/etc/resources.wrf4g
      sed -i "s#\$WRF4G_LOCATION#$WRF4G_LOCATION#" ${WRF4G_LOCATION}/etc/resources.wrf4g
    fi
    
    echo -n "Starting DRM4G (GridWay) .... "
    if test -f $GW_LOCATION/var/.lock; then
      echo -e "ERROR: GridWay is already running." 
    else
      $GW_LOCATION/bin/gwd && echo "OK"
    fi
    
    grep "DB_.*=" ${WRF4G_LOCATION}/etc/framework4g.conf | sed -e 's/\ *=\ */=/' > db4g.conf.temp
    source db4g.conf.temp
    if [ $WRF4G_DB_LOCAL -eq 1 ]; then
      cd $MYSQL_LOCATION
      echo -n "Starting WRF4G_DB (MySQL) ... "
      if test -f $MYSQL_LOCATION/data/`hostname`.pid; then
        mysql_pid=$(cat $MYSQL_LOCATION/data/`hostname`.pid)
        if test $(ps -p $mysql_pid | grep -m1 -c $mysql_pid) -eq 1; then
          echo -e "ERROR: MySQL is already running."
          exit 0
        fi
      fi
      if [ $(netstat -atn | grep LISTEN | grep -m1 -c ":$WRF4G_DB_PORT ") -eq 1 ]; then
        echo -e "ERROR: Another process is listening on port $WRF4G_DB_PORT."
        echo -e "Change WRF4G_DB_PORT in $WRF4G_LOCATION/etc/framework4g.conf to start MySQL on a different port."
        exit 0
      fi
      
      nohup ./bin/mysqld_safe --no-defaults --port=$WRF4G_DB_PORT --socket=$MYSQL_LOCATION/data/mysql.sock --log-error=$WRF4G_LOCATION/var/mysql.log &>/dev/null &
      cd - &>/dev/null
      echo "OK"
    fi

    sed 's/WRF4G_DB_LOCAL.*/# DataBase Configuration/' db4g.conf.temp >${WRF4G_LOCATION}/etc/db4g.conf
    rm db4g.conf.temp   
  ;;
  stop)
    #Stopping gwd 
    echo -n "Stopping DRM4G (GridWay) .... "
    $GW_LOCATION/bin/gwd -k && echo "OK"
    rm -f $GW_LOCATION/var/.lock
    #Stopping mysqld
    grep "DB_.*=" ${WRF4G_LOCATION}/etc/framework4g.conf | sed -e 's/\ *=\ */=/' > db4g.conf.temp
    source db4g.conf.temp; rm db4g.conf.temp
    if [ $WRF4G_DB_LOCAL -eq 1 ]; then
      echo -n "Stopping WRF4G_DB (MySQL) ... "
      if test ! -f $MYSQL_LOCATION/data/`hostname`.pid; then
        echo -e "ERROR: MySQL is already stopped."
        exit 0
      else
        mysql_pid=$(cat $MYSQL_LOCATION/data/`hostname`.pid)
        if test -n "`ps h -p $mysql_pid`" ; then
          mysql_ppid=$(ps h -p $mysql_pid -o ppid)
          if test -n $mysql_ppid; then 
            kill -9 $mysql_ppid
          fi
          if test -n $mysql_pid ; then 
            kill -9 $mysql_pid 
          fi
          echo "OK"
        else
          echo -e "ERROR: MySQL is already stopped."
        fi
      fi
    fi
  ;;
  restart)
    # Stop the service and regardless of whether it was
    # running or not, start it again.
    $0 stop
    $0 start
  ;;
  reload)
    # Only reloads gridway
    echo -n "Reloading DRM4G (GridWay) .... "
    $GW_LOCATION/bin/gwd -k && $GW_LOCATION/bin/gwd && echo "OK"
  ;;
  status)
    # Checking if gwd is running
    echo -n "DRM4G (GridWay) is "
    $GW_LOCATION/bin/gwd -s
    # Checking if mysqld is running
    grep "DB_.*=" ${WRF4G_LOCATION}/etc/framework4g.conf | sed -e 's/\ *=\ */=/' > db4g.conf.temp
    source db4g.conf.temp; rm db4g.conf.temp
    if [ $WRF4G_DB_LOCAL -eq 1 ]; then
      if test ! -f $MYSQL_LOCATION/data/`hostname`.pid; then
        echo "WRF4G_DB (MySQL) is stopped"
      else
        mysql_pid=$(cat $MYSQL_LOCATION/data/`hostname`.pid)
        if test $(ps -p $mysql_pid | grep -m1 -c $mysql_pid) -eq 1; then
          echo "WRF4G_DB (MySQL) is running"
        else
          echo "WRF4G_DB (MySQL) is stopped"
        fi
      fi
    fi
  ;;
  *)
    cat <<EOF
USAGE 
  $(basename $0) {start|stop|restart|status|reload}

SYNOPSYS
  wrf4g_framework manages WRF4G framework components: DRM4G and WRF4G_DB. 
  It loads the framework configuration from etc/framework4g.conf.


EOF
    exit 1
  ;;
esac
