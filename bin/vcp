#!/usr/bin/env python

from wrf4g_env import *
import vcplib
from os.path import basename, dirname, join

#***************************************************************************#
#                                        vcp (MAIN)                                                     #
#***************************************************************************#

def main():
    usage = """%prog [OPTIONS] SOURCE DEST
    Example: %prog -r /tmp/prueba gsiftp://se01.macc.unican.es/tmp/valva
    URL examples:
    
    LFN              lfn:///grid/VO/file file://home/user/file 
    GRIDFTP          gridftp://computer:2812/grid/VO/user/file
    RSYNC            rsync://user@computer:34/grid/VO/user/file
    SIMBOLIC LINK    ln:/home/user/file or ln:file
    FILE             file:/home/user/file file:/home/user/file2
    HTTPS            https://www.meteo.unican.es/work/WRF4G.tar.gz
    HTTP             http://www.meteo.unican.es/work/WRF4G.tar.gz
    FTP              ftp://www.meteo.unican.es/work/WRF4G.tar.gz
    """
    parser = OptionParser(usage, version="%prog 1.0")
    parser.add_option("-v", "--verbose", 
                      action="store_true", 
                      dest="verbose", 
                      default=False, 
                      help="Verbose mode. Explain what is being done")
    parser.add_option("-o", "--overwrite",
                      action="store_true",
                      dest="overwrite",
                      default=True,
                      help="If the destination already exists but is not a directory, it will be overwritten")
    
    (options, args) = parser.parse_args()
    if len(args) != 2:
        parser.error("Incorrect number of arguments")
        sys.exit(-1)
    try:
        orig = args[0]
        dest = args[1]
        orig_file = basename(orig)
        if '*' in orig_file :
            orig_dir = dirname(orig)
            for file in vcplib.VCPURL(orig_dir).ls(orig_file):
                vcplib.copy(join(orig_dir, file), dest, overwrite = options.overwrite, verbose=options.verbose)
        else:
            vcplib.copy(orig, dest, overwrite = options.overwrite, verbose=options.verbose)
    except Exception, e:
        sys.stderr.write('Caught exception: %s\n' % (str(e)))
        sys.exit(-1)

if __name__ == "__main__":
    main()
