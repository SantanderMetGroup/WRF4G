#! /bin/bash
#
# Lost files collector. In a perfect world, this script would never be needed.
#
# Not working yet: needs to find register_file and find out the kind of file
# and get the date from the file and...

function nitems(){
  # number of files matching a regex
  ls -1 $1 2> /dev/null | wc -l 
}

function allButNewest(){
  # list of files matching a regex, except the most recent
  ls -1t $1 2> /dev/null | awk 'NR!=1' 
}


max_dom=$(awk -F= '/max_dom/ {print $2}' namelist.input | tr -d ',')

for dom in $(seq 1 $max_dom); do
  for patt in "wrfout_d0${dom}*" "wrfrst_d0${dom}*" "wrfxtrm_d0${dom}*" "wrfrain_d0${dom}*"; do
    if test $(nitems "$patt") -ge 2; then
      for f in $(allButNewest "$patt"); do
        register_file out $f
      done
    fi
  done
done
