#! /bin/bash

# wrf4g_framework manages DRM4G (GridWay) and WRF4G_DB (MySQL) components of WRF4G.

# Common initialization
. `dirname $0`/wrf4g_env

case "$1" in
  start)
    sed -i "s#\$HOSTNAME#$HOSTNAME#" $FRAMEWORK4G_CONF
    if test -f ${WRF4G_LOCATION}/etc/resources.wrf4g; then
      sed -i 's/\ *=\ */=/' ${WRF4G_LOCATION}/etc/resources.wrf4g
      sed -i "s#\$WRF4G_LOCATION#$WRF4G_LOCATION#" ${WRF4G_LOCATION}/etc/resources.wrf4g
    fi
    
    echo -n "Starting DRM4G (GridWay) ...."
    if test -f $GW_LOCATION/var/.lock; then
      echo -e " FAILED. GridWay is already running." 
    else
      gwd
      st=$?
      if test $st -ne 0; then 
        echo -e " FAILED. Problems starting GridWay $st"
        exit 2 
      fi
      echo " OK"
    fi
    
    grep "DB_.*=" ${WRF4G_LOCATION}/etc/framework4g.conf | sed -e 's/\ *=\ */=/' > db4g.conf.temp
    source db4g.conf.temp
    if [ $WRF4G_DB_LOCAL -eq 1 ]; then
      cd $MYSQL_LOCATION
      echo -n "Starting WRF4G_DB (MySQL) ..."
      if test -f $MYSQL_LOCATION/data/`hostname`.pid; then
        mysql_pid=$(cat $MYSQL_LOCATION/data/`hostname`.pid)
        if test $(ps -p $mysql_pid | grep -m1 -c $mysql_pid) -eq 1; then
          echo -e " FAILED. MySQL is already running."
          exit 3
        fi
      fi
      if [ $(netstat -atn |grep LISTEN | grep -m1 -c ":$WRF4G_DB_PORT ") -eq 1 ]; then
        echo -e " FAILED. Another process is listening on port $WRF4G_DB_PORT."
        echo -e "Change WRF4G_DB_PORT in $WRF4G_LOCATION/etc/framework4g.conf to start MySQL on a different port."
        exit 4         
      fi
      
      nohup ./bin/mysqld_safe --no-defaults --port=$WRF4G_DB_PORT --socket=$MYSQL_LOCATION/data/mysql.sock --log-error=$WRF4G_LOCATION/var/mysql.log &>/dev/null &
      cd - &>/dev/null
      echo " OK"
    fi
      sed 's/WRF4G_DB_LOCAL.*/# DataBase Configuration/' db4g.conf.temp >${WRF4G_LOCATION}/etc/db4g.conf
      rm db4g.conf.temp   
  ;;
  stop)
    echo -n "Stopping DRM4G (GridWay) ...."
    rm -f $GW_LOCATION/var/.lock
    if test ! -f $GW_LOCATION/var/gwd.port; then
      echo -e " FAILED. GridWay is already stopped." 
    else
      gwd_port=$(cat $GW_LOCATION/var/gwd.port  | awk '{print $2}')
      gwd_pid=$(netstat -atnp 2>/dev/null | grep gwd | grep $gwd_port | awk '{print $7}'| sed s#/gwd##)
      if test -n "$gwd_pid"; then  
        kill -9 $gwd_pid
        echo " OK"
      else
        echo -e " FAILED. GridWay is already stopped."
      fi
    fi
    grep "DB_.*=" ${WRF4G_LOCATION}/etc/framework4g.conf | sed -e 's/\ *=\ */=/' > db4g.conf.temp
    source db4g.conf.temp; rm db4g.conf.temp
    if [ $WRF4G_DB_LOCAL -eq 1 ]; then
      echo -n "Stopping WRF4G_DB (MySQL) ..."
      if test ! -f $MYSQL_LOCATION/data/`hostname`.pid; then
        echo -e " FAILED. MySQL is already stopped." 
      else
        mysql_pid=$(cat $MYSQL_LOCATION/data/`hostname`.pid)
        if test -n "`ps h -p $mysql_pid`" ; then 
          mysql_ppid=$(ps h -p $mysql_pid -o ppid)
          if test -n $mysql_ppid; then kill -9 $mysql_ppid ;fi
          if test -n $mysql_pid ; then kill -9 $mysql_pid ;fi
          echo " OK"
        else
          echo -e " FAILED. MySQL is already stopped."
        fi
      fi
    fi
  ;;
  restart)
    ## Stop the service and regardless of whether it was
    ## running or not, start it again.
    $0 stop
    $0 start
    ;;
  reload)
    # Only reloads gridway
    echo -n "Reloading DRM4G (GridWay) ...."
    gwd_port=$(cat $GW_LOCATION/var/gwd.port  | awk '{print $2}')
    gwd_pid=$(netstat -atnp 2>/dev/null | grep gwd | grep $gwd_port | awk '{print $7}'| sed s#/gwd##)
    if test -n "$gwd_pid"; then  
      kill -9 $gwd_pid
    else
      echo -e " FAILED. \nProblems killing GridWay $st"
      exit 2
    fi
    rm -f $GW_LOCATION/var/.lock
    gwd 
    st=$?
    if test $st -ne 0; then 
      echo -e " FAILED. \nProblems starting GridWay $st"
      exit 2 
    fi
    echo " OK"
  ;;
  status)
    if test ! -f $GW_LOCATION/var/gwd.port; then
      echo "DRM4G (GridWay) NOT running" 
    else  
      gwd_port=$(cat $GW_LOCATION/var/gwd.port  | awk '{print $2}')
      gwd_pid=$(netstat -atnp 2>/dev/null | grep gwd | grep $gwd_port | awk '{print $7}'| sed s#/gwd##)
      if test -n "$gwd_pid"; then  
        echo "DRM4G (GridWay) is running"
      else
        echo "DRM4G (GridWay) is NOT running"
      fi
    fi
    if test ! -f $MYSQL_LOCATION/data/`hostname`.pid; then
      echo "WRF4G_DB (MySQL) NOT running"
    else
      mysql_pid=$(cat $MYSQL_LOCATION/data/`hostname`.pid)
      if test $(ps -p $mysql_pid | grep -m1 -c $mysql_pid) -eq 1; then
        echo "WRF4G_DB (MySQL) is running"
      else
        echo "WRF4G_DB (MySQL) is NOT running"
      fi
    fi
  ;;
  *)
    cat <<EOF
USAGE 
  $(basename $0) {start|stop|restart|status|reload}

SYNOPSYS
  wrf4g_framework manages WRF4G framework components: DRM4G and WRF4G_DB. 
  It load the framework configuration from etc/framework4g.conf.


EOF
    exit 1
  ;;
esac
